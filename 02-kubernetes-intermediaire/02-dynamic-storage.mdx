# ğŸ› ï¸ TP - Gestion dynamique du stockage avec les StorageClass

## ğŸ¯ Objectifs

- Comprendre le rÃ´le des **StorageClass** dans Kubernetes.
- ExpÃ©rimenter le provisionnement dynamique de volumes persistants.
- Utiliser un serveur **NFS** pour le stockage et lier un volume Ã  un
  **dÃ©ploiement Kubernetes**.

## ğŸ“š Introduction

Dans Kubernetes, une **StorageClass** permet d'automatiser la crÃ©ation et la
gestion des volumes persistants. Cela simplifie le stockage pour les
applications, offrant flexibilitÃ© et scalabilitÃ©. Dans ce TP, nous allons
utiliser un serveur **NFS** comme backend de stockage et configurer une
**StorageClass** pour provisionner dynamiquement des volumes.

## ğŸ°ï¸ PrÃ©requis

Avant de commencer, assurez-vous d'avoir :

- Un cluster Kubernetes fonctionnel (Minikube, K3s, ou montÃ© avec kubeadm).
- `kubectl` installÃ© et configurÃ©.
- Un serveur **NFS** en place. (Dans le meme rÃ©seau que le cluster)

### VÃ©rification du cluster Kubernetes

VÃ©rifiez que votre cluster est opÃ©rationnel avec la commande :

```bash
kubectl cluster-info
```

Si le cluster fonctionne, vous verrez une sortie indiquant l'adresse de l'API
**Kubernetes**.

## ğŸ¢ Ã‰tape 1 - Installation d'un serveur NFS

Si vous n'avez pas encore de serveur NFS, vous pouvez en installer un sur une
machine Ubuntu :

```bash
sudo apt update
sudo apt install nfs-server -y
```

CrÃ©ez un rÃ©pertoire partagÃ© :

```bash
sudo mkdir -p /data
```

Ajoutez ce partage au fichier **/etc/exports** :

```bash
echo "/data *(rw,sync,no_subtree_check)" | sudo tee -a /etc/exports
```

RedÃ©marrez le service NFS :

```bash
sudo systemctl restart nfs-kernel-server
```

## ğŸ¡ Ã‰tape 2 - CrÃ©ation d'une StorageClass

CrÃ©ez un fichier **storageclass-nfs.yaml** :

```yaml
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: nfs-csi
provisioner: nfs.csi.k8s.io
parameters:
  server: 192.168.1.100  # Remplacez par l'adresse IP de votre serveur NFS
  share: /data
reclaimPolicy: Retain
volumeBindingMode: Immediate
allowVolumeExpansion: true
```

Appliquez cette StorageClass :

```bash
kubectl apply -f storageclass-nfs.yaml
```

VÃ©rifiez la StorageClass crÃ©Ã©e :

```bash
kubectl get storageclass
```

## ğŸ›‹ï¸ Ã‰tape 3 - CrÃ©ation d'un PersistentVolumeClaim

CrÃ©ez un fichier **pvc-nfs.yaml** :

```yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: pvc-nfs
spec:
  accessModes:
    - ReadWriteMany
  resources:
    requests:
      storage: 5Gi
  storageClassName: nfs-csi
```

Appliquez le PVC :

```bash
kubectl apply -f pvc-nfs.yaml
```

VÃ©rifiez son statut :

```bash
kubectl get pvc
```

Le statut doit Ãªtre **Bound**, indiquant que le PVC est liÃ© Ã  un volume.

## ğŸŒ€ Ã‰tape 4 - Utilisation du PVC dans un DÃ©ploiement

CrÃ©ez un fichier **deployment-nfs.yaml** :

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nfs-deployment
spec:
  replicas: 2
  selector:
    matchLabels:
      app: nfs-app
  template:
    metadata:
      labels:
        app: nfs-app
    spec:
      containers:
        - name: app
          image: nginx
          volumeMounts:
            - name: storage
              mountPath: /usr/share/nginx/html
      volumes:
        - name: storage
          persistentVolumeClaim:
            claimName: pvc-nfs
```

Appliquez le dÃ©ploiement :

```bash
kubectl apply -f deployment-nfs.yaml
```

VÃ©rifiez les Pods crÃ©Ã©s :

```bash
kubectl get pods
```

## ğŸ“Š Ã‰tape 5 - VÃ©rification de la persistance des donnÃ©es

AccÃ©dez Ã  l'un des Pods et crÃ©ez un fichier :

```bash
kubectl exec -it <pod-name> -- /bin/sh
```

Ajoutez du contenu dans le volume montÃ© :

```sh
echo "Hello Kubernetes Storage" > /usr/share/nginx/html/index.html
```

Sortez du Pod et supprimez-le :

```bash
kubectl delete pod <pod-name>
```

CrÃ©ez un nouveau Pod et vÃ©rifiez que le fichier est toujours prÃ©sent :

```bash
kubectl exec -it <new-pod-name> -- cat /usr/share/nginx/html/index.html
```

Si le fichier est toujours lÃ , cela prouve que le stockage est persistant.

## ğŸ”§ DÃ©pannage et Debugging

Si vous rencontrez des problÃ¨mes, voici quelques commandes utiles :

- VÃ©rifier les Ã©vÃ©nements du PVC :

  ```bash
  kubectl describe pvc pvc-nfs
  ```

- VÃ©rifier les logs du driver CSI :

  ```bash
  kubectl logs -n kube-system -l app=csi-nfs-controller
  ```

- VÃ©rifier si un volume est bien montÃ© sur un Pod :

  ```bash
  kubectl exec -it <pod-name> -- df -h
  ```

## ğŸ† Conclusion

Vous avez appris Ã  :

- CrÃ©er et configurer une **StorageClass**.
- Provisionner dynamiquement un **PersistentVolumeClaim**.
- Lier ce volume Ã  un **dÃ©ploiement Kubernetes**.
- VÃ©rifier la persistance des donnÃ©es aprÃ¨s la suppression des Pods.

Continuez Ã  explorer en testant d'autres types de stockage comme **GlusterFS**,
**Ceph** ou **Longhorn** pour adapter votre solution aux besoins de production !
ğŸš€

